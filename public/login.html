<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cash Flow Tracker - Login</title>
    <script>
      document.documentElement.classList.toggle("dark", localStorage.getItem("theme") === "dark");
    </script>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body class="auth-body">
    <main class="auth-shell">
      <section class="auth-card">
        <header class="auth-header">
          <div class="brand">Cash Flow Tracker</div>
          <p class="auth-subtitle">Masuk untuk akses jurnal pembukuan pribadi.</p>
        </header>

        <form id="loginForm" class="auth-form">
          <label class="field">
            <span>Username</span>
            <input name="username" autocomplete="username" required />
          </label>

          <label class="field">
            <span>Password</span>
            <input name="password" type="password" autocomplete="current-password" required />
          </label>

          <button class="btn primary" type="submit">Login</button>
        </form>

        <div id="msg" class="msg"></div>

        <button id="openRegisterBtn" class="btn ghost" type="button">First time? Register (Invite Only)</button>
      </section>
    </main>

    <div id="registerModal" class="modal" role="dialog" aria-modal="true" hidden>
      <div class="modal-card">
        <div class="modal-head">
          <h2>Register</h2>
          <button id="closeRegisterModal" class="btn">âœ•</button>
        </div>
        <form id="registerForm" class="auth-form">
          <label class="field">
            <span>Full Name</span>
            <input name="full_name" autocomplete="name" />
          </label>
          <label class="field">
            <span>Invite Code</span>
            <input name="invite_code" autocomplete="off" required />
          </label>
          <label class="field">
            <span>Username</span>
            <input name="username" autocomplete="username" required />
          </label>
          <label class="field">
            <span>Password</span>
            <input name="password" type="password" autocomplete="new-password" required />
          </label>
          <button class="btn primary" type="submit">Register</button>
        </form>
      </div>
    </div>

    <script>
      const msg = document.getElementById("msg");

      const postJson = (url, body) =>
        fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) })
          .then(async (r) => ({ ok: r.ok, data: await r.json().catch(() => ({})) }));

      const redirectIfLoggedIn = async () => {
        try {
          const res = await fetch("/api/me", { credentials: "include" });
          if (res.ok) location.href = "./app.html";
        } catch {
          // ignore
        }
      };

      window.addEventListener("pageshow", redirectIfLoggedIn);
      redirectIfLoggedIn();

      document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "";
        const fd = new FormData(e.target);
        const res = await postJson("/api/auth/login", Object.fromEntries(fd.entries()));
        if (res.ok && res.data.ok) location.href = "./app.html";
        else msg.textContent = res.data.detail || "Login gagal";
      });

      document.getElementById("registerForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "";
        const fd = new FormData(e.target);
        const res = await postJson("/api/auth/register", Object.fromEntries(fd.entries()));
        msg.textContent = res.ok ? "Register sukses. Sekarang login." : (res.data.detail || "Register gagal");
        if (res.ok) document.getElementById("registerModal").hidden = true;
      });

      const registerModal = document.getElementById("registerModal");
      document.getElementById("openRegisterBtn").addEventListener("click", () => {
        registerModal.hidden = false;
      });
      document.getElementById("closeRegisterModal").addEventListener("click", () => {
        registerModal.hidden = true;
      });
      registerModal.addEventListener("click", (e) => e.target === registerModal && (registerModal.hidden = true));
    </script>
  </body>
</html>
